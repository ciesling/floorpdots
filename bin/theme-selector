#!/usr/bin/env bash
# rofi theme selector
# https://github.com/cherrynoize/dotfiles
# Author:= cherrynoize
# Thanks:= https://github.com/gh0stzk/dotfiles

wallpaper_themes_dir="$HOME/.wallpaper-themes"
thumbnail_cache_dir="$HOME/.cache/themes/thumbnails"
thumbnail_size=500x475
current_theme="$(theme show)"
rofi_cmd="rofi -dmenu -i -theme ~/.config/rofi/theme-selector/theme-selector.rasi"

gen_thumbnail () {
  thumb="$thumbnail_cache_dir/${thumbnail_size}_$(basename "$1")"

  if [ ! -d "$thumbnail_cache_dir" ]; then
    mkdir -p "$thumbnail_cache_dir"
  fi

  if [ ! -f "$thumb" ]; then
    convert -strip "$1" \
      -thumbnail "$thumbnail_size"^ \
      -extent "$thumbnail_size" \
      -gravity center \
      "$thumb"
  fi
  echo "$thumb"
}

launch_rofi () {
  printf "%s\n" "${options[@]}" |
    while read -r theme_name; do
      theme="${theme_map[$theme_name]}"
      wallpaper_dir="$wallpaper_themes_dir/$theme/wallpaper"
      random_wall="$wallpaper_dir/$(random-file "$wallpaper_dir")"
      thumbnail="$(gen_thumbnail "$random_wall")"
      echo -en "$theme_name\x00icon\x1f$thumbnail\n"
    done | $rofi_cmd -selected-row "${selected_index:-0}"
}

mapfile -t themes < <(theme list)
declare -A theme_map

# list themes
for theme in "${themes[@]}"; do
  theme_name="$(theme name "$theme")"
  theme_map["$theme_name"]="$theme"

  options+=("$theme_name")

  # select current theme by index
  if [ "$current_theme" = "$theme" ]; then
      selected_index="$index"
  fi

  (( index++ ))
done

# launch rofi menu and store result
selected="$(launch_rofi)"

[ -n "$selected" ] || exit 1
theme -n set "${theme_map[$selected]}"
