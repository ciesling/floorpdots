#!/usr/bin/env bash

# api
api_provider="${api_provider:-wttr.in}"
api_key=""

# location
ip_info_city_name="$(get-ip-info city)"
city_name="${ip_info_city_name:-Milan}"
city_name="${CITY:-$city_name}"
ip_info_country_name="$(coco "$(get-ip-info country)")"
country_name="${ip_info_country_name:-Italy}"
country_name="${COUNTRY:-$country_name}"

encode_to_url_format () {
  echo "${1// /%20}"
}

get_weather_icon () {
  get_weather_mini | awk '{print $1;}'
}

get_weather_temp () {
  get_weather_mini | awk '{print $2;}'
}

get_weather_mini () {
  weather="$(curl -s wttr.in/${city_name:-$country_name}?format=3)"

  if [ "$(echo "$weather" | grep -cE "(Unknown|curl|HTML)")" -gt 0 ]; then
      echo "WEATHER UNAVAILABLE"
  else
      echo "$weather" | awk '{print $2" "$3;}'
  fi
}

get_weather () {
  case "$api_provider" in
    wttr.in)
      encoded_location="$(encode_to_url_format "$city_name, $country_name")"
      curl -s "wttr.in/$encoded_location?tqp0"
      ;;
    openweathermap.org)
      city_url_encoding=$(encode_to_url_format "$city_name")
      WEATHER=$(curl -sf "api.openweathermap.org/data/2.5/weather?q=$city_url_encoding&appid=$api_key&units=metric")

      WEATHER_DESC=$(echo "$WEATHER" | jq -r ".weather[0].main")
      WEATHER_TEMP=$(echo "$WEATHER" | jq ".main.temp" | cut -d "." -f 1)
      WEATHER_ICON_CODE=$(echo "$WEATHER" | jq -r ".weather[].icon" | head -1)
      WEATHER_FEELS_LIKE=$(echo "$WEATHER" | jq ".main.feels_like" | cut -d "." -f 1)
      WEATHER_HUMIDITY=$(echo "$WEATHER" | jq ".main.humidity" | cut -d "." -f 1)
      WEATHER_ICON=""
      WEATHER_HEX=""

      case "$WEATHER_ICON_CODE" in
        "01d")
          WEATHER_ICON="󰖙"
          WEATHER_HEX="#ffd86b"
          ;;
        "01n")
          WEATHER_ICON="󰖔"
          WEATHER_HEX="#fcdcf6"
          ;;
        "02d")
          WEATHER_ICON="󰖕"
          WEATHER_HEX="#adadff"
          ;;
        "02n")
          WEATHER_ICON="󰼱"
          WEATHER_HEX="#adadff"
          ;;
        "03d")
          WEATHER_ICON="󰖐"
          WEATHER_HEX="#adadff"
          ;;
        "03n")
          WEATHER_ICON="󰖐"
          WEATHER_HEX="#adadff"
          ;;
        "04d")
          WEATHER_ICON="󰖐"
          WEATHER_HEX="#adadff"
          ;;
        "04n")
          WEATHER_ICON="󰖐"
          WEATHER_HEX="#acb0d0"
          ;;
        "09d")
          WEATHER_ICON="󱐋"
          WEATHER_HEX="#6b95ff"
          ;;
        "09n")
          WEATHER_ICON="󱐋"
          WEATHER_HEX="#6b95ff"
          ;;
        "10d")
          WEATHER_ICON="󱐋"
          WEATHER_HEX="#6b95ff"
          ;;
        "10n")
          WEATHER_ICON="󱐋"
          WEATHER_HEX="#6b95ff"
          ;;
        "11d")
          WEATHER_ICON="󱐋"
          WEATHER_HEX="#ffeb57"
          ;;
        "11n")
          WEATHER_ICON="󱐋"
          WEATHER_HEX="#ffeb57"
          ;;
        "13d")
          WEATHER_ICON="󰜗"
          WEATHER_HEX="#e3e6fc"
          ;;
        "13n")
          WEATHER_ICON="󰜗"
          WEATHER_HEX="#e3e6fc"
          ;;
        "40d")
          WEATHER_ICON="󰖝"
          WEATHER_HEX="#84afdb"
          ;;
        "40n")
          WEATHER_ICON="󰖝"
          WEATHER_HEX="#84afdb"
          ;;
        *)
          WEATHER_ICON="󰖐"
          WEATHER_HEX="#adadff"
          ;;
      esac

      case "$1" in
        "current_temp")
          echo "${WEATHER_TEMP:-0}"
          ;;
        "current_temp_fahrenheit")
          WEATHER_TEMP=$((("$WEATHER_TEMP" * 9 / 5) + 32))
          echo "${WEATHER_TEMP:-0}"
          ;;
        "feels_like")
          echo "${WEATHER_FEELS_LIKE:-0}"
          ;;
        "humidity")
          echo "${WEATHER_HUMIDITY:-0}"
          ;;
        "weather_desc")
          [[ -z "$WEATHER_DESC" ]] && echo "not available" || echo "$WEATHER_DESC"
          ;;
        "icon")
          echo "$WEATHER_ICON"
          ;;
        "hex")
          echo "$WEATHER_HEX"
          ;;
        "full")
          echo "$WEATHER"
          ;;
        "city")
          echo "$city_name"
          ;;
      esac
      ;;
esac
}

case "$1" in
  country)
    echo "$country_name"
    ;;
  city)
    echo "$city_name"
    ;;
  icon)
    get_weather_icon "$@"
    ;;
  temp)
    get_weather_temp "$@"
    ;;
  mini)
    get_weather_mini "$@"
    ;;
  "")
    get_weather "$@"
    ;;
  *)
    echo "error: unknown option '$1'"
    exit 1
    ;;
esac
