#!/bin/sh
# change-wallpaper
# author | cherrynoize
# https://github.com/cherrynoize
#
# BUGS:
# - seems not to work with filenames containing spaces, but I
#   believe it might be wpgtk, not us (testing needed)

# we cd here to set a relative wallpaper dir symlink
working_dir="$HOME"

# relative path to wallpaper dir (from working dir)
wallpaper_dir=".wallpaper-themes/current/wallpaper"

# location for link to current wallpaper
wall_link="$HOME/.current-wallpaper"

# link to ff wallpaper
[ -n "$FF_DEFAULT_PROFILE" ] && ff_wall_link="$HOME/.mozilla/firefox/$FF_DEFAULT_PROFILE/chrome/images/wallpaper"

# wpgtk templates directory
wpg_dir="$HOME/.config/wpg/templates"

# current wallpaper name
current_wall="$(wpg -c)"

# update symlink to current wallpaper
update_wall_symlink () {
  # remove old symlink
  if [ -L "$1" ]; then
    rm "$1"
  fi

  # create new symlink
  if [ ! -e "$1" ]; then
    ln -s "$wall_path" "$1"
  else
    echo "warning: '$1' is not a symlink"
    echo "ignoring symlink creation"
  fi
}

# update ff wallpaper
update_ff_wall_link () {
  [ -e "$1" ] && rm "$1"
  ln "$wall_path" "$1"
}

cd "$working_dir" || {
  echo "error: failed to cd to $working_dir"
  exit 4
}

case "$1" in
  "")
    if [ ! -d "$wallpaper_dir" ]; then
      echo "error: no wallpaper theme currently set"
      echo "try running \`switch-theme wallpaper [theme]\`"
      exit 5
    fi

    # pick random file in wall dir excluding current wall
    wall="$(random-file "$wallpaper_dir" -I "$current_wall")"
    ;;
  -r|--reload)
    wall="$current_wall"
    ;;
  *)
    # set wallpaper name
    wall="$1"
    ;;
esac

wall_path="$wallpaper_dir/$wall"

# if wallpaper is not in wpgtk yet
if ! wpg -l | grep -q "$wall"; then
  # add wallpaper and generate colorscheme with wpgtk
  wpg -a "$wall_path" && # add wallpaper and generate colorscheme
    wpg --sat "$wall" -0.1 && # decrease saturation
    wpg --sat "$wall" 0.12 # increase saturation
fi

wpg -s "$wall" # set wallpaper and colorscheme

update_wall_symlink "$wall_link" # update link to current wallpaper
[ -n "$ff_wall_link" ] && update_ff_wall_link "$ff_wall_link" # update link to wallpaper in ff

# update firefox colorscheme
pywalfox update

# update screenlock wallpaper cache
n3lock -w "$wall_path"

# TODO
# - auto-check wpgtk wallpapers dir for size or number of files
#   and remove older ones
